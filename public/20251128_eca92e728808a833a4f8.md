---
title: Cloud Storageで既存オブジェクトを上書きするときは削除権限も必要
tags:
  - IAM
  - CloudStorage
  - GoogleCloud
private: false
updated_at: '2025-11-28T00:07:34+09:00'
id: eca92e728808a833a4f8
organization_url_name: null
slide: false
ignorePublish: false
---

## 発生した問題

以下のようなコードで `file.save()` を実行した際、ファイルが既に存在する場合にエラーになりました。

```typescript
const content = "Hello, World!";
const storage = new Storage(storageOptions);
const bucket = storage.bucket("my-bucket");
const file = bucket.file("path/to/my-file.txt");
await file.save(Buffer.from(content, "utf-8"), {
  contentType: "text/plain",
});
```

## 原因
[Cloud Storage に適用される IAM 権限  |  Google Cloud Documentation](https://docs.cloud.google.com/storage/docs/access-control/iam-permissions?hl=ja#objects) を確認すると以下の記述がありました。

> **注:** 既存のオブジェクトを置換するには、storage.objects.create と storage.objects.delete の両方の権限が必要です。

どうやら上書きは、「削除」→「作成」のような考え方のようで、createとdelete両方の権限が必要とのことです。
ちなみにupdate権限は存在しません。

## 結論
既存オブジェクトの置換には `storage.objects.create` と `storage.objects.delete` の両方が必要です。

該当のサービスアカウントに `storage.objects.delete` を追加したところ解決しました。
