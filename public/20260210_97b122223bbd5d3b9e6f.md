---
title: GitHub Actions の actions/labeler でリリースラベルを自動付与しようとしたらハマった
tags:
  - GitHubActions
private: false
updated_at: '2026-02-10T11:56:47+09:00'
id: 97b122223bbd5d3b9e6f
organization_url_name: null
slide: false
ignorePublish: false
---

## actions/labeler とは

https://github.com/actions/labeler

PRに自動でラベルを付与する便利なアクション。ブランチパターンに基づいてラベルを付ける機能もあるため、リリースPRの管理に活用できる。

## やりたかったこと

`develop -> qa` または `qa -> main` へのPRに、自動で `release` ラベルを付与したい。つまり、以下の条件をOR結合したいと考えていた。

`(base=qa AND head=develop) OR (base=main AND head=qa)`

## 最初の設定

```yaml
release:
  - all:
    - base-branch: ['^(qa|main)$']
    - head-branch: ['^(develop|qa)$']
```

正規表現の alternation（`|`）を使い、単一の all ブロックで両方のパターンをカバーしていた。

## AIコードレビューによる指摘

この設定に対し、AIコードレビューツールから以下の指摘を受けた。

> 「この設定では develop -> main という意図しない組み合わせもマッチしてしまう。条件を分離し、明示的な組み合わせにするべき」

確かに論理的には正しい指摘である。base-branch と head-branch はそれぞれ独立して評価されるため、以下の全組み合わせがマッチしてしまう。

| head \ base | qa | main |
| --- | --- | --- |
| develop | ✅ develop→qa | ⚠️ develop→main |
| qa | - | ✅ qa→main |

## ダメだった

AIの指摘に従い、論理的に厳密になるよう2つの all ブロックに分離した。

```yaml
release:
  - all:
    - base-branch: ['^qa$']
    - head-branch: ['^develop$']
  - all:
    - base-branch: ['^main$']
    - head-branch: ['^qa$']
```

一見、「条件1 OR 条件2」を記述しているように見える。しかし、この設定に変更した途端、releaseラベルが付与されなくなった。

## 原因

actions/labeler v6 のソースコードを確認すると、原因が判明した。

https://github.com/actions/labeler/blob/v6.0.1/src/labeler.ts#L100-L113

トップレベルの設定項目（`- all:` や `- any:` の各ブロック）はすべてAND結合される仕様になっており、先ほどの2つの `- all:` ブロックは「両方のブロックを同時に満たす必要がある」と解釈されていた。

develop -> qa のPRの場合：

- ブロック1（base=qa, head=develop）：✅ マッチ
- ブロック2（base=main, head=qa）：❌ マッチしない
- 結果：false（両方同時にマッチしないため、ラベル付与なし）

## 正規表現パターンで妥協

actions/labeler の現在の仕様では、`(A AND B) OR (C AND D)` のような複合条件を、独立したブロックとして正確に表現する手段がない。そのため、以下のように正規表現を用いて1つの all ブロックにまとめるのが最も現実的な対応となる。

```yaml
release:
  - all:
    - base-branch: ['^(qa|main)$']
    - head-branch: ['^(develop|qa)$']
```

この設定では develop -> main もマッチしてしまうが、あくまでreleaseラベルを自動付与するためのアクションだったのでこれで妥協。
